// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 1. ServiceMaster (One row = one UID / service / contract)
model ServiceMaster {
  id                        Int       @id @default(autoincrement())
  uid                       String    @unique
  parent_uid                String?
  vendor                    String?
  vendor_service            String?
  service                   String?
  service_description       String?
  contract                  String?
  service_start_date        DateTime?
  service_end_date          DateTime?
  renewal_date              DateTime?
  budget_head               String?
  tower                     String?
  priority                  String?
  initiative_type           String?   // New / Existing
  service_type              String?   // Shared / Dedicated
  allocation_type           String?   // Dedicated / Shared
  cost_optimization_lever   String?
  remarks                   String?
  remark_logs               ServiceRemarkLog[]

  procurement_details       ProcurementDetail[]
  allocation_bases          AllocationBasis[]
  fy_actuals                FYActual[]
  monthly_actuals           MonthlyEntityActual[]
  entity_allocations        ServiceEntityAllocation[]

  @@index([uid])
  @@index([vendor])
  @@index([tower])
  @@index([budget_head])
}

model ServiceEntityAllocation {
  id          Int           @id @default(autoincrement())
  service_id  Int
  entity_id   Int
  count       Float         @default(0)
  
  service     ServiceMaster @relation(fields: [service_id], references: [id])
  entity      EntityMaster  @relation(fields: [entity_id], references: [id])
  
  @@unique([service_id, entity_id])
}

model ServiceRemarkLog {
  id          Int           @id @default(autoincrement())
  service_id  Int
  remark      String
  user_name   String?
  createdAt   DateTime      @default(now())

  service     ServiceMaster @relation(fields: [service_id], references: [id])
}

// 2. ProcurementDetail (PR / PO information linked to UID)
model ProcurementDetail {
  id                        Int            @id @default(autoincrement())
  service_id                Int
  entity                    String?        // Legacy/Direct field if needed
  pr_number                 String?
  pr_date                   DateTime?
  pr_amount                 Float?
  currency                  String?        @default("INR")
  po_number                 String?
  po_date                   DateTime?
  po_value                  Float?
  common_currency           String?        @default("INR")
  common_currency_value_inr Float?
  value_in_lac              Float?         // = common_currency_value_inr / 100000

  service                   ServiceMaster  @relation(fields: [service_id], references: [id])
}

// 3. AllocationBasis (How cost is split)
model AllocationBasis {
  id                        Int            @id @default(autoincrement())
  service_id                Int
  basis_of_allocation       String?
  allocation_basis          String?
  total_count               Int?

  service                   ServiceMaster  @relation(fields: [service_id], references: [id])
}

// 4. EntityMaster (Allocation Receiving Units)
model EntityMaster {
  id                        Int            @id @default(autoincrement())
  entity_name               String         @unique

  monthly_actuals           MonthlyEntityActual[]
  allocations               ServiceEntityAllocation[]
}

// 5. POEntityMaster (Procurement Entities)
model POEntityMaster {
  id                        Int            @id @default(autoincrement())
  entity_name               String         @unique
}

// 6. BudgetHeadMaster
model BudgetHeadMaster {
  id                        Int            @id @default(autoincrement())
  head_name                 String         @unique
}

// 7. TowerMaster
model TowerMaster {
  id                        Int            @id @default(autoincrement())
  tower_name                String         @unique
}

// 8. AllocationTypeMaster
model AllocationTypeMaster {
  id                        Int            @id @default(autoincrement())
  type_name                 String         @unique
}

// 9. AllocationBasisMaster
model AllocationBasisMaster {
  id                        Int            @id @default(autoincrement())
  basis_name                String         @unique
}

// 10. FYActual (FY-level totals â€“ Excel control numbers)
model FYActual {
  id                        Int            @id @default(autoincrement())
  service_id                Int
  financial_year            String         // e.g. FY25
  fy_budget                 Float          @default(0)
  fy_actuals                Float          @default(0) // = SUM(monthly_entity_actuals.amount)

  service                   ServiceMaster  @relation(fields: [service_id], references: [id])

  @@unique([service_id, financial_year])
  @@index([financial_year])
}

// 6. MonthlyEntityActual (Granular rows replacing hundreds of columns)
model MonthlyEntityActual {
  id                        Int            @id @default(autoincrement())
  service_id                Int
  entity_id                 Int
  month_no                  Int            // 1 to 12
  amount                    Float          @default(0)

  service                   ServiceMaster  @relation(fields: [service_id], references: [id])
  entity                    EntityMaster   @relation(fields: [entity_id], references: [id])

  @@unique([service_id, entity_id, month_no])
}

// User & Auth
model User {
  id                Int       @id @default(autoincrement())
  name              String
  email             String    @unique
  password_hash     String
  passwordChangedAt DateTime?
  is_active         Boolean   @default(true)
  created_at        DateTime  @default(now())
  updated_at        DateTime  @default(now()) @updatedAt
  currentSessionId  String?
  roles             UserRole[]
  
  currency_rates       CurrencyRate[]       @relation("CurrencyRateUpdatedBy")
  activity_logs        UserActivityLog[]
  audit_logs           AuditLog[]
  imports              ImportHistory[]
}

model Role {
  id    Int        @id @default(autoincrement())
  name  String     @unique // Viewer, Editor, Approver, Admin
  users UserRole[]
}

model UserRole {
  id      Int  @id @default(autoincrement())
  user_id Int
  role_id Int
  user    User @relation(fields: [user_id], references: [id])
  role    Role @relation(fields: [role_id], references: [id])

  @@unique([user_id, role_id])
}

// Core Masters & Logs
model AuditLog {
  id         Int      @id @default(autoincrement())
  entityType String
  entityId   Int
  action     String
  oldValue   String?  // JSON string
  newValue   String?  // JSON string
  comment    String?  // MANDATORY REASON FOR CHANGE
  userId     Int
  createdAt  DateTime @default(now())
  
  user       User     @relation(fields: [userId], references: [id])
}

model ImportHistory {
  id            Int      @id @default(autoincrement())
  type          String   // BUDGET / ACTUAL
  filename      String
  totalRows     Int
  acceptedRows  Int
  rejectedRows  Int
  status        String   // COMPLETED / FAILED
  userId        Int?
  user          User?    @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())
}

model CurrencyRate {
  id              Int      @id @default(autoincrement())
  from_currency   String
  to_currency     String
  rate            Float
  effective_date  DateTime @default(now())
  updated_by_id   Int?
  updated_by      User?    @relation("CurrencyRateUpdatedBy", fields: [updated_by_id], references: [id])
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@unique([from_currency, to_currency])
}

model UserActivityLog {
  id          Int      @id @default(autoincrement())
  user_id     Int?
  username    String?
  action      String
  details     String?
  ip_address  String?
  timestamp   DateTime @default(now())
  user        User?    @relation(fields: [user_id], references: [id])
}
